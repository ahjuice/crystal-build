#!/usr/bin/env perl

use strict;
use warnings;
use utf8;

use FindBin;
use lib (
    "$FindBin::Bin/../vendor/lib",
    "$FindBin::Bin/../lib"
);

use Cwd qw/abs_path/;

use Crenv;
use Crenv::Utils;
use Crenv::Fetcher;

sub main {
    my $args        = Crenv::Utils::parse_args(@ARGV);
    my $github_repo = 'manastech/crystal';
    my $cache_dir   = $ENV{CRYSTAL_BUILD_CACHE_PATH} // '.';

    my $share_url  = 'https://raw.githubusercontent.com/pine613/crystal-build/master/share/crystal-build/';
    my $cache_url  = $share_url.'/releases.json';
    my $shards_url = $share_url.'/shards.json';

    my $crenv = Crenv->new(
        prefix      => $args->{prefix},
        cache       => $args->{cache},
        cache_url   => $cache_url,
        shards_url  => $shards_url,
        cache_dir   => abs_path($cache_dir),
        fetcher     => Crenv::Fetcher->get(fetcher_type()),
        github_repo => $github_repo,
    );

    if ($args->{definitions}) {
        $crenv->show_definitions;
    }

    else {
        $crenv->install($args->{version});
    }
}

sub fetcher_type {
    `which curl` ? 'curl' :
    `which wget` ? 'wget' :
        die 'Need curl or wget';
}

main unless caller;

# vim: se et ts=4 sw=4 sts=4 ft=perl :
